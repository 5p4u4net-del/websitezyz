<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>902ç­ç”Ÿæ´»å„€è¡¨æ¿</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --primary:#4f46e5;--primary-light:#c7d2fe;--primary-dark:#3730a3;
  --success:#10b981;--warning:#f59e0b;--danger:#ef4444;--info:#3b82f6;
  --bg:#f1f5f9;--card:#fff;--text:#1e293b;--muted:#64748b;
  --border:#e2e8f0;--radius:12px;--shadow:0 2px 12px rgba(0,0,0,.08);
}
body{font-family:'Noto Sans TC',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.hidden{display:none!important}

/* â”€â”€ Login â”€â”€ */
#loginPage{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:1rem}
.login-card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:2.5rem;width:100%;max-width:400px}
.login-logo{text-align:center;margin-bottom:1.5rem}
.login-logo h1{font-size:1.5rem;font-weight:700;color:var(--primary)}
.login-logo p{color:var(--muted);font-size:.875rem;margin-top:.25rem}
.role-tabs{display:flex;gap:.5rem;margin-bottom:1.5rem;background:#f1f5f9;border-radius:8px;padding:4px}
.role-tab{flex:1;padding:.5rem;border:none;background:transparent;border-radius:6px;cursor:pointer;font-size:.875rem;font-weight:500;color:var(--muted);transition:all .2s}
.role-tab.active{background:#fff;color:var(--primary);box-shadow:0 1px 4px rgba(0,0,0,.1)}
.form-group{margin-bottom:1rem}
.form-group label{display:block;font-size:.875rem;font-weight:500;margin-bottom:.4rem;color:var(--text)}
.form-group input{width:100%;padding:.6rem .9rem;border:1px solid var(--border);border-radius:8px;font-size:1rem;outline:none;transition:border-color .2s}
.form-group input:focus{border-color:var(--primary)}
.hint{font-size:.75rem;color:var(--muted);margin-top:.3rem}
.btn-login{width:100%;padding:.75rem;background:var(--primary);color:#fff;border:none;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;transition:background .2s}
.btn-login:hover{background:var(--primary-dark)}
.error-msg{background:#fef2f2;color:var(--danger);border:1px solid #fecaca;border-radius:8px;padding:.75rem 1rem;font-size:.875rem;margin-bottom:1rem}

/* â”€â”€ App Layout â”€â”€ */
#appPage{min-height:100vh;display:flex;flex-direction:column}
.topbar{background:var(--primary);color:#fff;padding:.75rem 1.5rem;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:10;box-shadow:0 2px 8px rgba(0,0,0,.15)}
.topbar-title{font-size:1rem;font-weight:700}
.topbar-meta{font-size:.8rem;opacity:.85}
.topbar-right{display:flex;align-items:center;gap:1rem}
.btn-logout{background:rgba(255,255,255,.2);border:none;color:#fff;padding:.35rem .9rem;border-radius:6px;cursor:pointer;font-size:.8rem;transition:background .2s}
.btn-logout:hover{background:rgba(255,255,255,.35)}
.main-content{flex:1;padding:1.5rem;max-width:960px;margin:0 auto;width:100%}

/* â”€â”€ Cards â”€â”€ */
.section-title{font-size:1.1rem;font-weight:700;margin-bottom:1rem;color:var(--text);display:flex;align-items:center;gap:.5rem}
.section-title::before{content:'';display:block;width:4px;height:1.1rem;background:var(--primary);border-radius:2px}
.cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1rem;margin-bottom:1.5rem}
.info-card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:1.25rem;border-left:4px solid var(--primary)}
.info-card.success{border-color:var(--success)}
.info-card.warning{border-color:var(--warning)}
.info-card.danger{border-color:var(--danger)}
.info-card.info{border-color:var(--info)}
.info-card h3{font-size:.8rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:.6rem}
.info-card p{font-size:.95rem;color:var(--text);white-space:pre-wrap;line-height:1.6}
.info-card a{color:var(--primary);font-weight:600;text-decoration:none}
.info-card a:hover{text-decoration:underline}

/* â”€â”€ Teacher Table â”€â”€ */
.table-wrap{overflow-x:auto;background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow)}
.data-table{width:100%;border-collapse:collapse;font-size:.85rem}
.data-table th{background:#f8fafc;padding:.75rem 1rem;text-align:left;font-weight:600;color:var(--muted);border-bottom:2px solid var(--border);white-space:nowrap}
.data-table td{padding:.7rem 1rem;border-bottom:1px solid var(--border);vertical-align:top;line-height:1.5}
.data-table tr:last-child td{border-bottom:none}
.data-table tr:hover td{background:#f8fafc}
.badge{display:inline-block;padding:.15rem .55rem;border-radius:99px;font-size:.75rem;font-weight:600}
.badge-success{background:#dcfce7;color:#15803d}
.badge-warning{background:#fef9c3;color:#854d0e}
.badge-info{background:#dbeafe;color:#1d4ed8}
.filter-bar{display:flex;gap:.75rem;margin-bottom:1rem;flex-wrap:wrap;align-items:center}
.filter-bar input{padding:.5rem .9rem;border:1px solid var(--border);border-radius:8px;font-size:.875rem;outline:none;width:200px}
.filter-bar input:focus{border-color:var(--primary)}

/* â”€â”€ Responsive â”€â”€ */
@media(max-width:600px){
  .cards-grid{grid-template-columns:1fr}
  .main-content{padding:1rem}
  .topbar{padding:.75rem 1rem}
}
</style>
</head>
<body>

<!-- ========== ç™»å…¥é  ========== -->
<div id="loginPage">
  <div class="login-card">
    <div class="login-logo">
      <h1>902ç­ç”Ÿæ´»å„€è¡¨æ¿</h1>
      <p>è‘³ä¸­ç¬¬18å±† â€” ç­ç´šè³‡è¨ŠæŸ¥è©¢ç³»çµ±</p>
    </div>

    <div class="role-tabs">
      <button class="role-tab active" data-role="student" onclick="setRole('student')">å­¸ç”Ÿç™»å…¥</button>
      <button class="role-tab" data-role="parent" onclick="setRole('parent')">å®¶é•·ç™»å…¥</button>
      <button class="role-tab" data-role="teacher" onclick="setRole('teacher')">å°å¸«ç™»å…¥</button>
    </div>

    <div id="errorMsg" class="error-msg hidden"></div>

    <form onsubmit="doLogin(event)">
      <div class="form-group">
        <label id="accountLabel">å­¸è™Ÿ</label>
        <input id="inputAccount" type="text" placeholder="è«‹è¼¸å…¥å­¸è™Ÿ" autocomplete="username" required>
      </div>
      <div class="form-group">
        <label>å¯†ç¢¼</label>
        <input id="inputPassword" type="password" placeholder="" autocomplete="current-password" required>
        <p id="pwHint" class="hint">å¯†ç¢¼ç‚ºç”Ÿæ—¥ MMDDï¼Œä¾‹å¦‚ 8æœˆ16æ—¥è«‹è¼¸å…¥ 0816</p>
      </div>
      <button type="submit" class="btn-login" id="btnLogin">ç™»å…¥</button>
    </form>
  </div>
</div>

<!-- ========== ä¸»æ‡‰ç”¨é  ========== -->
<div id="appPage" class="hidden">
  <div class="topbar">
    <div>
      <div class="topbar-title">902ç­ç”Ÿæ´»å„€è¡¨æ¿</div>
      <div class="topbar-meta" id="topbarMeta"></div>
    </div>
    <div class="topbar-right">
      <span id="topbarName" style="font-size:.875rem"></span>
      <button class="btn-logout" onclick="doLogout()">ç™»å‡º</button>
    </div>
  </div>

  <div class="main-content" id="mainContent">
    <p style="color:var(--muted);text-align:center;padding:3rem">è¼‰å…¥ä¸­...</p>
  </div>
</div>

<script src="config.js"></script>
<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentRole = 'student';
let session = null;

// â”€â”€ Role tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setRole(role) {
  currentRole = role;
  document.querySelectorAll('.role-tab').forEach(t =>
    t.classList.toggle('active', t.dataset.role === role)
  );
  const label = document.getElementById('accountLabel');
  const hint  = document.getElementById('pwHint');
  const acct  = document.getElementById('inputAccount');

  if (role === 'student') {
    label.textContent = 'å­¸è™Ÿ';
    acct.placeholder  = 'è«‹è¼¸å…¥å­¸è™Ÿï¼Œä¾‹å¦‚ 1120041';
    hint.textContent  = 'å¯†ç¢¼ç‚ºç”Ÿæ—¥ MMDDï¼Œä¾‹å¦‚ 8æœˆ16æ—¥è«‹è¼¸å…¥ 0816';
  } else if (role === 'parent') {
    label.textContent = 'å­¸è™Ÿï¼ˆå­©å­çš„å­¸è™Ÿï¼‰';
    acct.placeholder  = 'è«‹è¼¸å…¥å­©å­çš„å­¸è™Ÿ';
    hint.textContent  = 'å¯†ç¢¼ç‚ºå­©å­èº«åˆ†è­‰è™Ÿå¾Œ4ç¢¼';
  } else {
    label.textContent = 'å°å¸«å¸³è™Ÿ';
    acct.placeholder  = 'è«‹è¼¸å…¥å°å¸«å¸³è™Ÿ';
    hint.textContent  = 'å°å¸«å°ˆç”¨å¸³è™Ÿ';
  }
  hideError();
}

// â”€â”€ API call â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function api(body) {
  const res = await fetch(CONFIG.SCRIPT_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain' },
    body: JSON.stringify(body)
  });
  return res.json();
}

// â”€â”€ Login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doLogin(e) {
  e.preventDefault();
  hideError();
  const btn  = document.getElementById('btnLogin');
  btn.textContent = 'ç™»å…¥ä¸­...';
  btn.disabled = true;

  const account  = document.getElementById('inputAccount').value.trim();
  const password = document.getElementById('inputPassword').value.trim();

  try {
    const data = await api({ action: 'login', role: currentRole, account, password });
    if (data.success) {
      session = { ...data, account };
      sessionStorage.setItem(CONFIG.SESSION_KEY, JSON.stringify(session));
      showApp();
    } else {
      showError(data.error || 'ç™»å…¥å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡');
    }
  } catch (err) {
    showError('ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¢ºèªç¶²è·¯é€£ç·šå¾Œå†è©¦');
  }
  btn.textContent = 'ç™»å…¥';
  btn.disabled = false;
}

// â”€â”€ Logout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doLogout() {
  sessionStorage.removeItem(CONFIG.SESSION_KEY);
  session = null;
  document.getElementById('loginPage').classList.remove('hidden');
  document.getElementById('appPage').classList.add('hidden');
  document.getElementById('inputPassword').value = '';
}

// â”€â”€ Show App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function showApp() {
  document.getElementById('loginPage').classList.add('hidden');
  document.getElementById('appPage').classList.remove('hidden');

  const roleLabel = { student: 'å­¸ç”Ÿ', parent: 'å®¶é•·', teacher: 'å°å¸«' };
  document.getElementById('topbarMeta').textContent = roleLabel[session.role] + ' æ¨¡å¼';
  document.getElementById('topbarName').textContent = session.name;

  const mc = document.getElementById('mainContent');
  mc.innerHTML = '<p style="color:var(--muted);text-align:center;padding:3rem">è³‡æ–™è¼‰å…¥ä¸­...</p>';

  try {
    const data = await api({
      action: 'getData',
      role:   session.role,
      seatNo: session.seatNo
    });

    if (!data.success) {
      mc.innerHTML = `<p style="color:var(--danger);text-align:center;padding:3rem">${data.error}</p>`;
      return;
    }

    if (session.role === 'teacher') {
      renderTeacher(data.students);
    } else {
      renderStudent(data.data, session.name, session.role);
    }
  } catch (err) {
    mc.innerHTML = `<p style="color:var(--danger);text-align:center;padding:3rem">è³‡æ–™è¼‰å…¥å¤±æ•—ï¼š${err.message}</p>`;
  }
}

// â”€â”€ Render Student / Parent â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderStudent(d, name, role) {
  const roleTag = role === 'parent' ? `ï¼ˆ${name} å®¶é•·ï¼‰` : '';

  // åˆ¤æ–·æ¬„ä½æ˜¯å¦ç‚ºé€£çµæ–‡å­—
  function linkOrText(val) {
    if (!val) return '<span style="color:var(--muted)">æš«ç„¡è³‡æ–™</span>';
    // è‹¥åŒ…å«ç¶²å€ï¼Œåšæˆé€£çµ
    const urlReg = /(https?:\/\/[^\s]+)/g;
    if (urlReg.test(val)) {
      return val.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">é»æ­¤æŸ¥è©¢ â†—</a>');
    }
    return val;
  }

  const cards = [
    { title: 'ç¼ºæ› ç‹€æ³',       value: d.absence,    color: 'warning', icon: 'ğŸ“‹' },
    { title: 'çæ‡²è¨˜éŒ„',       value: d.reward,     color: 'info',    icon: 'ğŸ…' },
    { title: 'æ¶ˆéé€²åº¦',       value: d.demerit,    color: 'danger',  icon: 'ğŸ“' },
    { title: 'åˆ°æ ¡äº¤é€šç‹€æ³',   value: d.transport,  color: 'success', icon: 'ğŸšŒ' },
    { title: 'å­¸æ ¡è²»ç”¨ç¹³äº¤ç‹€æ³', value: d.fee,      color: 'warning', icon: 'ğŸ’°' },
    { title: 'ç­ç´šä½œæ¥­ç¹³äº¤ç‹€æ³', value: d.homework, color: 'info',    icon: 'ğŸ“š' },
    { title: 'è€ƒè©¦è¡¨ç¾ç‹€æ³',   value: d.exam,       color: 'primary', icon: 'âœï¸' },
    { title: 'ç”Ÿæ´»å¸¸è¦è¡¨ç¾',   value: d.conduct,    color: 'success', icon: 'â­' },
    { title: 'å­¸ç¿’è¼”å°å»ºè­°',   value: d.counseling, color: '',        icon: 'ğŸ’¡' },
    { title: 'å‡å­¸é€²è·¯è¼”å°å»ºè­°', value: d.career,   value: d.career,  color: 'info', icon: 'ğŸ“' },
  ];

  const html = `
    <div class="section-title">ğŸ“Š ${name}${roleTag} å€‹äººè³‡è¨Šç¸½è¦½</div>
    <div class="cards-grid">
      ${cards.map(c => `
        <div class="info-card ${c.color}">
          <h3>${c.icon} ${c.title}</h3>
          <p>${linkOrText(c.value)}</p>
        </div>
      `).join('')}
    </div>
  `;
  document.getElementById('mainContent').innerHTML = html;
}

// â”€â”€ Render Teacher â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTeacher(students) {
  let filtered = [...students];

  function draw() {
    const keyword = (document.getElementById('searchInput')?.value || '').trim().toLowerCase();
    const show = keyword
      ? filtered.filter(s =>
          s.name.includes(keyword) ||
          String(s.seat).includes(keyword) ||
          String(s.studentId).includes(keyword)
        )
      : filtered;

    const tbody = document.getElementById('teacherTbody');
    if (!tbody) return;
    tbody.innerHTML = show.map(s => `
      <tr>
        <td>${s.seat}</td>
        <td>${s.name}</td>
        <td>${s.studentId}</td>
        <td>${fmt(s.absence)}</td>
        <td>${fmt(s.reward)}</td>
        <td>${fmt(s.demerit)}</td>
        <td>${fmt(s.transport)}</td>
        <td>${fmt(s.fee)}</td>
        <td>${fmt(s.homework)}</td>
        <td>${fmt(s.exam)}</td>
        <td>${fmt(s.conduct)}</td>
        <td>${fmt(s.counseling)}</td>
        <td>${fmt(s.career)}</td>
      </tr>
    `).join('');
  }

  function fmt(v) {
    if (!v) return '<span style="color:#ccc">â€”</span>';
    const urlReg = /(https?:\/\/[^\s]+)/;
    if (urlReg.test(v)) return '<a href="' + v.match(urlReg)[1] + '" target="_blank">æŸ¥è©¢ â†—</a>';
    return String(v).replace(/\n/g, '<br>');
  }

  const html = `
    <div class="section-title">ğŸ‘©â€ğŸ« å°å¸«æ¨¡å¼ â€” å…¨ç­ç¸½è¦½ï¼ˆå…± ${students.length} ä½ï¼‰</div>
    <div class="filter-bar">
      <input id="searchInput" type="text" placeholder="æœå°‹å§“å / åº§è™Ÿ / å­¸è™Ÿ..." oninput="window._teacherDraw()">
      <span style="font-size:.8rem;color:var(--muted)">é¡¯ç¤º ${students.length} ç­†</span>
    </div>
    <div class="table-wrap">
      <table class="data-table">
        <thead><tr>
          <th>åº§è™Ÿ</th><th>å§“å</th><th>å­¸è™Ÿ</th>
          <th>ç¼ºæ› </th><th>çæ‡²</th><th>æ¶ˆé</th><th>äº¤é€š</th>
          <th>è²»ç”¨</th><th>ä½œæ¥­</th><th>è€ƒè©¦</th><th>å¸¸è¦</th>
          <th>è¼”å°å»ºè­°</th><th>å‡å­¸å»ºè­°</th>
        </tr></thead>
        <tbody id="teacherTbody"></tbody>
      </table>
    </div>
  `;

  document.getElementById('mainContent').innerHTML = html;
  window._teacherDraw = draw;
  draw();
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showError(msg) {
  const el = document.getElementById('errorMsg');
  el.textContent = msg;
  el.classList.remove('hidden');
}
function hideError() {
  document.getElementById('errorMsg').classList.add('hidden');
}

// â”€â”€ Auto-restore session â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('DOMContentLoaded', () => {
  setRole('student'); // åˆå§‹åŒ– hint æ–‡å­—
  const saved = sessionStorage.getItem(CONFIG.SESSION_KEY);
  if (saved) {
    try {
      session = JSON.parse(saved);
      showApp();
    } catch(e) {
      sessionStorage.removeItem(CONFIG.SESSION_KEY);
    }
  }
});
</script>
</body>
</html>
